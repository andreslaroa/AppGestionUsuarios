@{
    ViewBag.Title = "Alta Masiva de Usuarios";
    Layout = "_Layout";
}

@section Styles {
      <style>
        .container {
          max-width: 100%;
          padding: 10px;
          font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        /* TABLA: layout fijo, ancho al 100%, letra algo más grande */
        #usersTable {
          width: 100%;
          table-layout: fixed;
          border-collapse: collapse;
          font-size: 12px;      /* aumentado */
        }

        /* Celdas: permiten wrap, vertical-align top para que empiece en la parte superior */
        #usersTable th,
        #usersTable td {
          border: 1px solid #ddd;
          padding: 6px;         /* un poco más de padding para altura */
          overflow: visible;    /* mostrar todo el contenido */
          white-space: normal;  /* permitir salto de línea */
          vertical-align: top;  /* alinea arriba si hay varias líneas */
        }

        /* Inputs y selects: fuente más grande y permiten texto multilínea */
        #usersTable input[type="text"],
        #usersTable input[type="date"],
        #usersTable select {
          width: 100%;
          font-size: 11px;      /* aumentado */
          padding: 4px;         /* más espacio interno */
          margin: 0;
          box-sizing: border-box;
          white-space: normal;  /* si el valor es largo, se envuelve */
          height: auto;         /* altura automática según contenido */
        }

        /* Botones un poco más grandes */
        button {
          font-size: 12px;
          padding: 8px 12px;
        }

        /* Mensajes y lista de detalles */
        #message {
          font-size: 12px;
          margin-top: 8px;
        }
        #detailsList {
          font-size: 11px;
          margin-top: 4px;
          padding-left: 16px;
        }
      </style>
}


<div class="container">
    <h1>@ViewBag.Title</h1>

    <div class="form-group">
        <label for="file">Selecciona el archivo Excel (.xlsx):</label>
        <input type="file"
               id="file"
               name="file"
               accept=".xlsx"
               class="form-control" />
    </div>
    <button type="button"
            id="btnLoad"
            class="btn btn-primary mb-3">
        Cargar Datos
    </button>

    <div id="usersTableContainer" style="display:none;">
        <table id="usersTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Apellido1</th>
                    <th>Apellido2</th>
                    <th>DNI</th>
                    <th>OU Principal</th>
                    <th>OU Secundaria</th>
                    <th>FechaCaducidad</th>
                    <th>nTelefono</th>
                    <th>MobileExt</th>
                    <th>MobileNumber</th>
                    <th>TarjetaId</th>
                    <th>nFuncionario</th>
                    <th>Grupos</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
        <button type="button"
                id="btnProcess"
                class="btn btn-success">
            Confirmar Alta Masiva
        </button>
    </div>

    <div id="message" class="mt-3 font-weight-bold"></div>
    <ul id="detailsList"></ul>
</div>

@section Scripts {
        <script>
        let usersData = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnLoad')
                    .addEventListener('click', loadFile);
            document.getElementById('btnProcess')
                    .addEventListener('click', processUsers);
        });

        async function loadFile() {
            const input = document.getElementById('file');
            if (!input.files.length) {
                alert('Seleccione un archivo .xlsx antes de continuar.');
                return;
            }
            const fd = new FormData();
            fd.append('file', input.files[0]);

            try {
                const res = await fetch('/AltaMasiva/LoadFile', {
                    method: 'POST',
                    body: fd
                });
                const data = await res.json();
                if (!data.success) {
                    alert(data.message);
                    return;
                }
                usersData = data.users;
                displayUsersTable();
            } catch (e) {
                console.error(e);
                alert('Error al cargar el archivo.');
            }
        }

        function displayUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            document.getElementById('usersTableContainer').style.display = 'block';

            usersData.forEach((u, i) => {
                const row = document.createElement('tr');

                // función helper para inputs
                const inp = (val, field) =>
                    `<input type="text" value="${val||''}" onchange="updateUser(${i},'${field}',this.value)" />`;

                row.innerHTML =
                    `<td>${inp(u.Nombre, 'Nombre')}</td>` +
                    `<td>${inp(u.Apellido1, 'Apellido1')}</td>` +
                    `<td>${inp(u.Apellido2, 'Apellido2')}</td>` +
                    `<td>${inp(u.DNI, 'DNI')}</td>` +
                    `<td>${inp(u.OUPrincipal, 'OUPrincipal')}</td>` +
                    `<td>${inp(u.OUSecundaria, 'OUSecundaria')}</td>` +
                    `<td><input type="date" value="${u.FechaCaducidad||''}" onchange="updateUser(${i},'FechaCaducidad',this.value)" /></td>` +
                    `<td>${inp(u.nTelefono, 'nTelefono')}</td>` +
                    `<td>${inp(u.MobileExt, 'MobileExt')}</td>` +
                    `<td>${inp(u.MobileNumber, 'MobileNumber')}</td>` +
                    `<td>${inp(u.TarjetaId, 'TarjetaId')}</td>` +
                    `<td>${inp(u.nFuncionario, 'nFuncionario')}</td>` +
                    `<td><input type="text" value="${(u.Grupos||[]).join(' ')}" onchange="updateUser(${i},'Grupos',this.value.split(' ').filter(s=>s))" /></td>`;

                tbody.appendChild(row);
            });
        }

        function updateUser(idx, field, val) {
            usersData[idx][field] = val;
        }

                async function processUsers() {
        if (!confirm('¿Procesar alta masiva?')) return;

        try {
          const res = await fetch('/AltaMasiva/ProcessUsers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(usersData)
          });
          const data = await res.json();

          // Construimos la lista de detalles
          let details = '— Sin detalles —';
          if (Array.isArray(data.messages) && data.messages.length > 0) {
            details = data.messages.join('\n');
          }

          // Mostramos un alert con resumen + detalles
          if (data.success) {
            alert(
              "✅ Alta masiva completada con éxito!\n\n" +
              "Detalles:\n" +
              details
            );
          } else {
            alert(
              "❌ Se produjeron errores en la alta masiva:\n\n" +
              details
            );
          }

          // También volcamos los detalles en la lista bajo la tabla
          const ul = document.getElementById('detailsList');
          ul.innerHTML = '';
          (data.messages || []).forEach(m => {
            const li = document.createElement('li');
            li.textContent = m;
            li.style.color = m.startsWith('Error') ? 'red' : 'green';
            ul.appendChild(li);
          });
        } catch (err) {
          console.error('Error en processUsers:', err);
          alert("❌ Ocurrió un error al procesar la alta masiva.");
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btnProcess').addEventListener('click', processUsers);
      });
        </script>
}
